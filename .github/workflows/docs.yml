name: Publish Docs

on:
  push:
    branches:
      - main
    tags:
      - "v*" # Triggers on tags like v1.0, v2.1.0

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Critical: allows pushing to gh-pages branch
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for mike to access git history

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: "pyproject.toml"

      - name: Install Dependencies
        run: uv sync --all-extras --group docs

      - name: Configure Git User
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Deploy Dev Docs (Main Branch)
        if: github.ref == 'refs/heads/main'
        # Deploys to a version named 'dev' without updating 'latest'
        run: uv run mike deploy dev --push

      - name: Deploy Release Documentation (Tags)
        if: startsWith(github.ref, 'refs/tags/v')
        # Deploy the tag, alias it to 'latest', AND make 'latest' the default landing page
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          uv run mike deploy $TAG_NAME latest --update-aliases --push
          uv run mike set-default latest --push
